{% extends "patient/base.html" %}
{% block title %}Patient Dashboard - Northern Health Innovations{% endblock %}

{% block content %}
<main class="p-4">
  <!-- Page header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">Patient Dashboard</h1>
      <p class="text-gray-600">Manage your health information and appointments</p>
    </div>
  </div>

  <!-- Welcome alert -->
  <div class="bg-blue-100 text-blue-700 px-6 py-4 rounded-lg relative mb-6">
    <div>
      <strong class="font-bold">Welcome, {{ patient_name|default:"Patient" }}!</strong>
      <span class="block sm:inline"> You have {{ appointments|length|default:"0" }} upcoming appointments scheduled.</span>
    </div>
  </div>

  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-bold text-gray-800">Health Overview</h2>
    <a href="{% url 'patient:schedule_appointment' %}" class="bg-[#004d40] hover:bg-[#00332e] text-white py-2 px-4 rounded-lg flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      New Appointment
    </a>
  </div>

  <!-- Stats grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <!-- Upcoming Appointments -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow">
      <div class="flex flex-wrap items-center">
        <div class="p-2 md:p-3 rounded-full bg-blue-200 bg-opacity-75 flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 text-blue-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="ml-3 md:ml-4 min-w-0 flex-1">
          <h3 class="text-xs md:text-sm text-gray-500 truncate">Upcoming Appointments</h3>
          <p class="text-xl md:text-2xl font-semibold text-gray-800">{{ appointments|length|default:"0" }}</p>
        </div>
      </div>
    </div>

    <!-- Active Prescriptions -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow">
      <div class="flex flex-wrap items-center">
        <div class="p-2 md:p-3 rounded-full bg-green-200 bg-opacity-75 flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 text-green-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
          </svg>
        </div>
        <div class="ml-3 md:ml-4 min-w-0 flex-1">
          <h3 class="text-xs md:text-sm text-gray-500 truncate">Active Prescriptions</h3>
          <p class="text-xl md:text-2xl font-semibold text-gray-800">{{ prescriptions|length|default:"0" }}</p>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow">
      <div class="flex flex-wrap items-center">
        <div class="p-2 md:p-3 rounded-full bg-purple-200 bg-opacity-75 flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 text-purple-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <div class="ml-3 md:ml-4 min-w-0 flex-1">
          <h3 class="text-xs md:text-sm text-gray-500 truncate">Unread Messages</h3>
          <p class="text-xl md:text-2xl font-semibold text-gray-800">{{ unread_messages_count|default:"0" }}</p>
        </div>
      </div>
    </div>

    <!-- Health Metrics -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow">
      <div class="flex flex-wrap items-center">
        <div class="p-2 md:p-3 rounded-full bg-yellow-200 bg-opacity-75 flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 text-yellow-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
          </svg>
        </div>
        <div class="ml-3 md:ml-4 min-w-0 flex-1">
          <h3 class="text-xs md:text-sm text-gray-500 truncate">Health Metrics</h3>
          <p class="text-xl md:text-2xl font-semibold text-gray-800">{{ health_metrics|length|default:"0" }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Card layout - cleaned version -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-20">
    <!-- Appointments -->
    <div class="bg-white p-6 rounded-xl shadow max-h-80 overflow-y-auto">
      <h3 class="text-xl font-semibold text-[#004d40] mb-4">ðŸ“… Your Appointments</h3>
      {% if appointments %}
        <ul class="space-y-2 text-gray-700">
          {% for appt in appointments %}
            <li><strong>{{ appt.doctor_name|default:"Dr." }}</strong> â€“ {{ appt.time|date:"M d, Y - g:i A" }} ({{ appt.type }})</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-600">No upcoming appointments. <a href="{% url 'patient:schedule_appointment' %}" class="text-[#004d40] hover:underline">Schedule one now</a>.</p>
      {% endif %}
      <div class="mt-4">
        <a href="{% url 'patient:patient_appointments' %}" class="text-[#004d40] hover:underline font-semibold">View all appointments â†’</a>
      </div>
    </div>

    <!-- Prescriptions -->
    <div class="bg-white p-6 rounded-xl shadow max-h-80 overflow-y-auto">
      <h3 class="text-xl font-semibold text-[#004d40] mb-4">ðŸ’Š Current Prescriptions</h3>
      {% if prescriptions %}
        <ul class="space-y-2 text-gray-700">
          {% for rx in prescriptions %}
            <li><strong>{{ rx.medication_name }}</strong> â€“ {{ rx.dosage }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-600">No active prescriptions.</p>
      {% endif %}
      <div class="mt-4">
        <a href="{% url 'patient:patient_prescriptions' %}" class="text-[#004d40] hover:underline font-semibold">Manage prescriptions â†’</a>
      </div>
    </div>

    <!-- Messages -->
    <div class="bg-white p-6 rounded-xl shadow max-h-80 overflow-y-auto">
      <h3 class="text-xl font-semibold text-[#004d40] mb-4">ðŸ“¨ Recent Messages</h3>
      {% if recent_messages %}
        {% for msg in recent_messages %}
          <p class="text-gray-700 mb-2"><strong>{{ msg.sender_name|default:"Provider" }}:</strong> "{{ msg.content|truncatechars:100 }}"</p>
        {% endfor %}
      {% else %}
        <p class="text-gray-600">No recent messages.</p>
      {% endif %}
      <div class="mt-4">
        <!-- Changed from patient_messages to patient_email -->
        <a href="{% url 'patient:patient_email' %}" class="text-[#004d40] hover:underline font-semibold">View all messages â†’</a>
      </div>
    </div>

    <!-- Health Summary -->
    <div class="bg-white p-6 rounded-xl shadow max-h-80 overflow-y-auto">
      <h3 class="text-xl font-semibold text-[#004d40] mb-4">ðŸ“„ Health Summary</h3>
      <p class="text-gray-700">Last updated: {% now "F d, Y" %}</p>
      {% if health_metrics %}
        <div class="mt-4 space-y-2">
          {% for metric in health_metrics %}
            <p class="text-gray-600">{{ metric.name }}: {{ metric.value }} {{ metric.unit }}</p>
          {% endfor %}
        </div>
      {% else %}
        <div class="mt-4 space-y-2">
          <p class="text-gray-600">No recent health metrics available.</p>
        </div>
      {% endif %}
      <div class="mt-4">
        <a href="{% url 'patient:patient_medical_history' %}" class="text-[#004d40] hover:underline font-semibold">View full health record â†’</a>
      </div>
    </div>
  </div>
</main>
{% endblock %}
