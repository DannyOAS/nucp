{% extends "provider/base.html" %}
{% block title %}Create Prescription - Northern Health Innovations{% endblock %}

{% block content %}
<div class="flex items-center mb-6">
  <a href="{% url 'provider_prescriptions' %}" class="text-[#004d40] hover:text-[#00332e] mr-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
    </svg>
  </a>
  <h2 class="text-xl font-bold text-gray-800">Create New Prescription</h2>
</div>

{% if messages %}
  <div class="mb-6">
    {% for message in messages %}
      <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<form method="POST" action="{% url 'create_prescription' %}">
  {% csrf_token %}
  
  <div class="bg-white rounded-xl shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-[#004d40]">Patient Selection</h3>
    </div>
    
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="patient_id" class="block text-sm font-medium text-gray-700 mb-1">Select Patient</label>
          <select id="patient_id" name="patient_id" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <option value="">Select a patient</option>
            {% for patient in patients %}
              <option value="{{ patient.id }}">{{ patient.first_name }} {{ patient.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div id="patientInfoSection" class="hidden">
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="font-medium text-gray-800 mb-1" id="selectedPatientName">Patient Name</div>
            <div class="text-sm text-gray-600" id="selectedPatientDOB">Date of Birth: </div>
            <div class="text-sm text-gray-600" id="selectedPatientOHIP">OHIP: </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-white rounded-xl shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-[#004d40]">Prescription Details</h3>
    </div>
    
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="medication_name" class="block text-sm font-medium text-gray-700 mb-1">Medication Name *</label>
          <input type="text" id="medication_name" name="medication_name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        
        <div>
          <label for="dosage" class="block text-sm font-medium text-gray-700 mb-1">Dosage *</label>
          <input type="text" id="dosage" name="dosage" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 500mg, twice daily">
        </div>
        
        <div>
          <label for="duration_months" class="block text-sm font-medium text-gray-700 mb-1">Duration (months) *</label>
          <input type="number" id="duration_months" name="duration_months" min="1" max="12" value="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        
        <div>
          <label for="refills" class="block text-sm font-medium text-gray-700 mb-1">Refills *</label>
          <input type="number" id="refills" name="refills" min="0" max="10" value="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        
        <div class="md:col-span-2">
          <label for="instructions" class="block text-sm font-medium text-gray-700 mb-1">Instructions *</label>
          <textarea id="instructions" name="instructions" rows="3" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Take one tablet by mouth twice daily with food"></textarea>
        </div>
        
        <div class="md:col-span-2">
          <label for="side_effects" class="block text-sm font-medium text-gray-700 mb-1">Side Effects</label>
          <textarea id="side_effects" name="side_effects" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., May cause drowsiness, dizziness, dry mouth"></textarea>
        </div>
        
        <div class="md:col-span-2">
          <label for="warnings" class="block text-sm font-medium text-gray-700 mb-1">Warnings/Precautions</label>
          <textarea id="warnings" name="warnings" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Do not drink alcohol while taking this medication"></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-white rounded-xl shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-[#004d40]">Pharmacy Information</h3>
    </div>
    
    <div class="p-6">
      <div class="mb-4">
        <label for="pharmacy" class="block text-sm font-medium text-gray-700 mb-1">Preferred Pharmacy *</label>
        <input type="text" id="pharmacy" name="pharmacy" value="Northern Pharmacy" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
      </div>
      
      <div class="mb-4">
        <div class="flex items-center">
          <input id="default_pharmacy" name="default_pharmacy" type="checkbox" checked class="h-4 w-4 text-[#004d40] border-gray-300 rounded focus:ring-[#004d40]">
          <label for="default_pharmacy" class="ml-2 block text-sm text-gray-700">Use patient's default pharmacy if available</label>
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-white rounded-xl shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-[#004d40]">Provider Information</h3>
    </div>
    
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="prescribed_by" class="block text-sm font-medium text-gray-700 mb-1">Prescribed By *</label>
          <input type="text" id="prescribed_by" name="prescribed_by" value="{{ provider_name|default:'Smith' }}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
      </div>
    </div>
  </div>
  
  <div class="flex justify-end">
    <a href="{% url 'provider_prescriptions' %}" class="mr-3 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 py-2 px-4 rounded-md">
      Cancel
    </a>
    <button type="submit" class="bg-[#004d40] hover:bg-[#00332e] text-white py-2 px-4 rounded-md">
      Create Prescription
    </button>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const patientSelect = document.getElementById('patient_id');
    const patientInfoSection = document.getElementById('patientInfoSection');
    const selectedPatientName = document.getElementById('selectedPatientName');
    const selectedPatientDOB = document.getElementById('selectedPatientDOB');
    const selectedPatientOHIP = document.getElementById('selectedPatientOHIP');
    
    // Patient selection handling
    patientSelect.addEventListener('change', function() {
      const patientId = this.value;
      
      if (patientId) {
        patientInfoSection.classList.remove('hidden');
        
        // In a real application, this information would be fetched from the server
        // or included in JSON data embedded in the page
        // For this example, we'll use placeholder data for a few patients
        const patients = {
          {% for patient in patients %}
          "{{ patient.id }}": {
            "name": "{{ patient.first_name }} {{ patient.last_name }}",
            "dob": "{{ patient.date_of_birth }}",
            "ohip": "{{ patient.ohip_number }}"
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
        };
        
        if (patients[patientId]) {
          selectedPatientName.textContent = patients[patientId].name;
          selectedPatientDOB.textContent = 'Date of Birth: ' + patients[patientId].dob;
          selectedPatientOHIP.textContent = 'OHIP: ' + patients[patientId].ohip;
        }
      } else {
        patientInfoSection.classList.add('hidden');
      }
    });
    
    // Form validation
    const form = document.querySelector('form');
    
    form.addEventListener('submit', function(e) {
      const patientId = patientSelect.value;
      const medicationName = document.getElementById('medication_name').value;
      const dosage = document.getElementById('dosage').value;
      const instructions = document.getElementById('instructions').value;
      
      if (!patientId || !medicationName || !dosage || !instructions) {
        e.preventDefault();
        alert('Please fill out all required fields.');
        return false;
      }
      
      // Confirm submission
      const confirmCreate = confirm('Are you sure you want to create this prescription?');
      if (!confirmCreate) {
        e.preventDefault();
        return false;
      }
    });
  });
</script>
{% endblock %}
